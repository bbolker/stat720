<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Generalized additive (mixed) models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="gams_files/libs/clipboard/clipboard.min.js"></script>
<script src="gams_files/libs/quarto-html/quarto.js"></script>
<script src="gams_files/libs/quarto-html/popper.min.js"></script>
<script src="gams_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="gams_files/libs/quarto-html/anchor.min.js"></script>
<link href="gams_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="gams_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="gams_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="gams_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="gams_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generalized additive (mixed) models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="additive-models" class="level2">
<h2 class="anchored" data-anchor-id="additive-models">Additive models</h2>
<ul>
<li>generally a way to specify more complex (smooth) terms based on <em>individual</em> covariates: <span class="math inline">\(\mu = \beta_0 + f_1(x_1) + f_2(x_2) + \ldots\)</span></li>
<li>lots of ways to generate <span class="math inline">\(f_i(x_i)\)</span>: kernel estimators, locally weighted polynomials, … see <span class="citation" data-cites="hastieGeneralized1990">T. J. Hastie and Tibshirani (<a href="#ref-hastieGeneralized1990" role="doc-biblioref">1990</a>)</span>, <span class="citation" data-cites="hastieElements2009">T. Hastie, Tibshirani, and Friedman (<a href="#ref-hastieElements2009" role="doc-biblioref">2009</a>)</span> (<em>backfitting algorithm</em> etc.)</li>
<li>we will focus on</li>
</ul>
</section>
<section id="basis-expansions" class="level2">
<h2 class="anchored" data-anchor-id="basis-expansions">Basis expansions</h2>
<ul>
<li>(theoretically) infinitely expandable</li>
<li>e.g.&nbsp;polynomials (‘regular’/raw, orthogonal, Legendre, Hermite)</li>
<li>wavelet, Fourier</li>
<li>splines: <strong>piecewise polynomial</strong> with continuity/smoothness constraints</li>
</ul>
</section>
<section id="spline-degree" class="level2">
<h2 class="anchored" data-anchor-id="spline-degree">Spline degree</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>xvec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sfun <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"bs"</span>, ...) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"bs"</span>) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> splines<span class="sc">::</span><span class="fu">bs</span>(xvec, <span class="at">df =</span> <span class="dv">10</span>, <span class="at">degree =</span> d)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> splines<span class="sc">::</span><span class="fu">ns</span>(xvec, <span class="at">df =</span> <span class="dv">10</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">bty =</span> <span class="st">"l"</span>, <span class="at">las =</span> <span class="dv">1</span>) </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matplot</span>(xvec, X, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">1</span>, ...)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sfun</span>(<span class="at">d =</span> <span class="dv">1</span>, <span class="at">main =</span> <span class="st">"degree-1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sfun</span>(<span class="at">d =</span> <span class="dv">2</span>, <span class="at">main =</span> <span class="st">"degree-2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sfun</span>(<span class="at">d =</span> <span class="dv">3</span>, <span class="at">main =</span> <span class="st">"degree-3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-1-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="spline-terminology" class="level2">
<h2 class="anchored" data-anchor-id="spline-terminology">spline terminology</h2>
<ul>
<li><strong>knots</strong>: breakpoints (boundary, interior)</li>
<li>order-M (ESL): continuous derivatives up to order <span class="math inline">\(M-2\)</span> (cubic, <span class="math inline">\(M=4\)</span>)</li>
<li>typically <span class="math inline">\(M=1\)</span>, 2, 4</li>
<li>number of knots = df (degrees of freedom) -1 -intercept</li>
</ul>
</section>
<section id="spline-choices" class="level2">
<h2 class="anchored" data-anchor-id="spline-choices">Spline choices</h2>
<ul>
<li>continuous derivatives up to <span class="math inline">\(d-1\)</span></li>
<li>truncated polynomial basis (simple)</li>
<li>B-splines: complex, but <em>minimal support</em>/maximum sparsity</li>
<li><em>natural</em> splines: extra constraint, derivatives &gt; 1 vanish at boundaries</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sfun</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sfun</span>(<span class="at">type =</span> <span class="st">"ns"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/b_vs_n-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="choosing-knot-locations" class="level2">
<h2 class="anchored" data-anchor-id="choosing-knot-locations">choosing knot locations</h2>
<ul>
<li>generally not that important: evenly spaced, <em>or</em> evenly spaced based on quantiles</li>
</ul>
</section>
<section id="choosing-basis-dimension" class="level2">
<h2 class="anchored" data-anchor-id="choosing-basis-dimension">choosing basis dimension</h2>
<ul>
<li>in principle could expand dimension to match total number of points (<em>interpolation spline</em>)</li>
<li>… but that would overfit</li>
<li>AIC, adjusted <span class="math inline">\(R^2\)</span>, cross-validation …</li>
</ul>
</section>
<section id="smoothing-splines" class="level2">
<h2 class="anchored" data-anchor-id="smoothing-splines">smoothing splines</h2>
<ul>
<li>as many knots as data points</li>
<li>plus squared-second-derivative (“wiggliness”) penalty</li>
</ul>
<p><span class="math display">\[
\textrm{RSS} + \lambda \int (f''(t))^2 \, dt
\]</span></p>
<ul>
<li>defined on an infinite-dimensional space</li>
<li>minimizer is a natural cubic spline with knots at <span class="math inline">\(x_i\)</span></li>
</ul>
<p><span class="math display">\[
(\mathbf y- \mathbf Z\mathbf b)^\top (\mathbf y- \mathbf Z\mathbf b) + \lambda \mathbf b^\top \boldsymbol \Omega\mathbf b
\]</span> with <span class="math inline">\(\{\boldsymbol \Omega\}_{jk} = \int \mathbf Z_j''(t) \mathbf Z_k''(t) \, dt\)</span> $$</p>
<ul>
<li><strong>generalized</strong> ridge regression: penalize by <span class="math inline">\(\lambda \boldsymbol \Omega_N\)</span> rather than <span class="math inline">\(\lambda I\)</span></li>
<li>same data augmentation methods as before except that now we use <span class="math inline">\(\sqrt{\lambda} C\)</span> where <span class="math inline">\(C\)</span> is a matrix, and the “square root” (Cholesky factor) of <span class="math inline">\(\boldsymbol \Omega_N\)</span></li>
</ul>
<p>See <span class="citation" data-cites="woodGeneralized2017">Simon N. Wood (<a href="#ref-woodGeneralized2017" role="doc-biblioref">2017</a>)</span>, <span class="citation" data-cites="perperogloureview2019a">Perperoglou et al. (<a href="#ref-perperogloureview2019a" role="doc-biblioref">2019</a>)</span></p>
</section>
<section id="connection-to-mixed-models" class="level2">
<h2 class="anchored" data-anchor-id="connection-to-mixed-models">connection to mixed models</h2>
<ul>
<li>note that <span class="math inline">\(\lambda \mathbf b^\top \boldsymbol \Omega\mathbf b\)</span> is equivalent to <span class="math inline">\((1/\sigma^2) \mathbf b\Sigma'^{-1} \mathbf b^\top\)</span>; if <span class="math inline">\(\Sigma'\)</span> is a <em>scaled</em> covariance matrix (i.e.&nbsp;<span class="math inline">\(\Sigma = \sigma^2 \Sigma\)</span>), then this is the core of the MVN log-likelihood <span class="math inline">\(\log {\cal L}(\mathbf b|\Sigma)\)</span> (all we’re missing is a factor of <span class="math inline">\(\textrm{Det}(\Sigma)^{-1/2}\)</span> and a normalization constant)</li>
<li>So we can fit this with any of the mixed model machinery, provided we can set up the correct covariance matrix</li>
<li>Or</li>
</ul>
</section>
<section id="generalized-cross-validation-score" class="level2">
<h2 class="anchored" data-anchor-id="generalized-cross-validation-score">generalized cross-validation score</h2>
<ul>
<li>very close to AIC</li>
<li><span class="citation" data-cites="larsenGAM2015">Larsen (<a href="#ref-larsenGAM2015" role="doc-biblioref">2015</a>)</span>, <span class="citation" data-cites="golubGeneralized1979">Golub, Heath, and Wahba (<a href="#ref-golubGeneralized1979" role="doc-biblioref">1979</a>)</span></li>
<li>minimize <span class="math inline">\(\textrm{RSS}/(\textrm{Tr}(\mathbf I-\mathbf S(\lambda)))^2\)</span>, where <span class="math inline">\(S\)</span> is</li>
<li>“a rotation-invariant version of PRESS” (<span class="math inline">\(\sum (e_i/(1-h_ii))^2\)</span>)</li>
<li>replace RSS with approximation of deviance, <span class="math display">\[
|| \sqrt{\mathbf W} (\mathbf z- {\mathbf X}\boldsymbol \beta)||^2
\]</span> for generalized (non-Gaussian) models</li>
</ul>
</section>
<section id="ml-criterion-reml-criterion" class="level2">
<h2 class="anchored" data-anchor-id="ml-criterion-reml-criterion">ML criterion, REML criterion</h2>
<ul>
<li>treat spline smoothing as a <em>mixed model</em> problem</li>
<li>spline (penalized) parameters are <span class="math inline">\(\mathbf u\)</span></li>
<li><span class="math inline">\(y|u \sim N({\mathbf X}\boldsymbol \beta+ \mathbf Z\mathbf u, \sigma^2 \mathbf I)\)</span>; <span class="math inline">\(\mathbf u\sim N(0, (\sigma^2/\lambda) \mathbf W^{-1})\)</span></li>
<li>where the <span class="math inline">\(\mathbf W\)</span> is the penalty matrix</li>
<li>corresponds to minimizing <span class="math inline">\(||\mathbf y- {\mathbf X}\boldsymbol \beta- \mathbf Z\mathbf u||^2 + \lambda \mathbf u^\top \mathbf W\mathbf u\)</span></li>
<li>“fixed effects are viewed as random effects with improper uniform priors and are integrated out” (Wood 2011)</li>
<li>Laplace approximation</li>
</ul>
</section>
<section id="practical-stuff" class="level2">
<h2 class="anchored" data-anchor-id="practical-stuff">practical stuff</h2>
<ul>
<li>Simon Wood is insanely smart, and <code>mgcv</code> is insanely powerful and flexible</li>
<li><a href="https://gavinsimpson.github.io/gratia/">gratia package</a> (named after <a href="https://en.wikipedia.org/wiki/Grace_Wahba">Grace Wahba</a></li>
<li>available ‘smooths’ (bases + penalty terms): look for strings of the form <code>smooth.construct.*.smooth.spec</code></li>
<li>although you can <em>theoretically</em> have as many knots as data points, fewer is often good enough/computationally efficient</li>
</ul>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ad"     "bs"     "cc"     "cp"     "cr"     "cs"     "ds"     "gp"    
 [9] "mrf"    "ps"     "re"     "sf"     "so"     "sos"    "sw"     "t2"    
[17] "tensor" "tp"     "ts"    </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">gam</span>(mpg <span class="sc">~</span> <span class="fu">s</span>(hp), <span class="at">data =</span> mtcars)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(g1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
mpg ~ s(hp)

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  20.0906     0.5487   36.62   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
        edf Ref.df     F p-value    
s(hp) 2.618  3.263 26.26  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.735   Deviance explained = 75.7%
GCV = 10.862  Scale est. = 9.6335    n = 32</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(g1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gam.check</span>(g1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: GCV   Optimizer: magic
Smoothing parameter selection converged after 4 iterations.
The RMS GCV score gradient at convergence was 4.290111e-05 .
The Hessian was positive definite.
Model rank =  10 / 10 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

        k'  edf k-index p-value
s(hp) 9.00 2.62    0.87    0.14</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(g1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">appraise</span>(g1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">gam</span>(mpg <span class="sc">~</span> <span class="fu">s</span>(hp), <span class="at">data =</span> mtcars, <span class="at">fit =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>concurvity</strong>: <a href="https://stats.stackexchange.com/questions/401401/what-is-the-acceptable-level-of-concurvity">CV question</a>, <span class="citation" data-cites="ramsayEffect2003">Ramsay, Burnett, and Krewski (<a href="#ref-ramsayEffect2003" role="doc-biblioref">2003</a>)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>g3 <span class="ot">&lt;-</span> <span class="fu">gam</span>(mpg <span class="sc">~</span> <span class="fu">s</span>(hp) <span class="sc">+</span> <span class="fu">s</span>(wt), <span class="at">data =</span> mtcars)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="gams_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">concurvity</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 para     s(hp)     s(wt)
worst    2.534737e-18 0.9575001 0.9575001
observed 2.534737e-18 0.6883189 0.6968782
estimate 2.534737e-18 0.4784240 0.7978191</code></pre>
</div>
</div>
<p>Many options: simple random effects (<code>bs = "re"</code>); <em>cyclic</em> splines (make <span class="math inline">\(x(0) = x(T)\)</span>; <code>bs="cc"</code>) ; multidimensional splines (thin-plate, <em>tensor product</em> (<code>te()</code>); spherical (<em>Duchon</em>) splines (<code>bs = "sos"</code>); Markov random fields (<code>bs = "mrf"</code>); Gaussian processes (<code>bs = "gp"</code>); splines by category (<code>by=</code> argument); hierarchical splines <span class="citation" data-cites="pedersenHierarchical2019">(<a href="#ref-pedersenHierarchical2019" role="doc-biblioref">Pedersen et al. 2019</a>)</span>; constrained splines (<code>scam</code> package, <span class="citation" data-cites="pyaShape2015">Pya and Wood (<a href="#ref-pyaShape2015" role="doc-biblioref">2015</a>)</span>); <em>soap film</em> splines; etc etc etc etc …</p>
<p><img src="pix/hgam.png" class="img-fluid"></p>
</section>
<section id="duality-between-mathbf-z-and-correlation-structure" class="level2">
<h2 class="anchored" data-anchor-id="duality-between-mathbf-z-and-correlation-structure">Duality between <span class="math inline">\(\mathbf Z\)</span> and correlation structure</h2>
<ul>
<li><span class="citation" data-cites="hefleyBasis2017">Hefley et al. (<a href="#ref-hefleyBasis2017" role="doc-biblioref">2017</a>)</span></li>
<li>“first-order specification”: <span class="math inline">\(\mathbf y\sim N({\mathbf X}\boldsymbol \beta+ \mathbf Z\mathbf b, \sigma^2_\epsilon \mathbf I)\)</span></li>
<li>“second-order specification: <span class="math inline">\(\mathbf y\sim N({\mathbf X}\boldsymbol \beta, \sigma^2_\epsilon \mathbf I+ \sigma^2_\mathbf b\Sigma)\)</span></li>
<li>if <span class="math inline">\(\mathbf b\)</span> are iid Normal, integrating first-order specification shows that <span class="math inline">\(\Sigma = \mathbf Z\mathbf Z^\top\)</span></li>
<li>e.g.&nbsp;latent-variable specification of an AR1 correlation structure</li>
<li>e.g.&nbsp;<code>phyloglmm</code></li>
</ul>
</section>
<section id="penalty-matrices-as" class="level2">
<h2 class="anchored" data-anchor-id="penalty-matrices-as">Penalty matrices as</h2>
<ul>
<li><span class="citation" data-cites="woodStable2004">Simon N. Wood (<a href="#ref-woodStable2004" role="doc-biblioref">2004</a>)</span></li>
</ul>
</section>
<section id="computational-tricks" class="level2">
<h2 class="anchored" data-anchor-id="computational-tricks">Computational tricks</h2>
<ul>
<li>work with <em>precision matrix</em> where possible <span class="math inline">\(\Sigma^{-1}\)</span></li>
<li>for a <strong>multivariate normal</strong> response, <span class="math inline">\(\Sigma^{-1}_{ij} = \Sigma^{-1}_{ji} = 0 \leftrightarrow\)</span> <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span> are <strong>conditionally independent</strong></li>
<li>e.g.&nbsp;precision matrix of AR1 is tridiagonal with diagonal <span class="math inline">\(1+\rho^2\)</span>, first off-diagonal elements <span class="math inline">\(-\rho\)</span> (see <a href="https://haakonbakkagit.github.io/btopic120.html">here</a>)</li>
<li>work with <em>reduced-rank</em> forms where necessary</li>
</ul>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-golubGeneralized1979" class="csl-entry" role="doc-biblioentry">
Golub, Gene H., Michael Heath, and Grace Wahba. 1979. <span>“Generalized <span>Cross-Validation</span> as a <span>Method</span> for <span>Choosing</span> a <span>Good Ridge Parameter</span>.”</span> <em>Technometrics</em> 21 (2): 215–23. <a href="https://doi.org/10.1080/00401706.1979.10489751">https://doi.org/10.1080/00401706.1979.10489751</a>.
</div>
<div id="ref-hastieGeneralized1990" class="csl-entry" role="doc-biblioentry">
Hastie, T. J., and R. J. Tibshirani. 1990. <em>Generalized <span>Additive Models</span></em>. <span>CRC Press</span>.
</div>
<div id="ref-hastieElements2009" class="csl-entry" role="doc-biblioentry">
Hastie, Trevor, Robert Tibshirani, and J. H Friedman. 2009. <em>The Elements of Statistical Learning: Data Mining, Inference, and Prediction</em>. <span>New York</span>: <span>Springer</span>. <a href="https://hastie.su.domains/Papers/ESLII.pdf">https://hastie.su.domains/Papers/ESLII.pdf</a>.
</div>
<div id="ref-hefleyBasis2017" class="csl-entry" role="doc-biblioentry">
Hefley, Trevor J., Kristin M. Broms, Brian M. Brost, Frances E. Buderman, Shannon L. Kay, Henry R. Scharf, John R. Tipton, Perry J. Williams, and Mevin B. Hooten. 2017. <span>“The Basis Function Approach for Modeling Autocorrelation in Ecological Data.”</span> <em>Ecology</em> 98 (3): 632–46. <a href="https://doi.org/10.1002/ecy.1674">https://doi.org/10.1002/ecy.1674</a>.
</div>
<div id="ref-larsenGAM2015" class="csl-entry" role="doc-biblioentry">
Larsen, Kim. 2015. <span>“<span>GAM</span>: <span>The Predictive Modeling Silver Bullet</span> | <span>Stitch Fix Technology</span> <span>Multithreaded</span>.”</span> <em>MultiThreaded (StitchFix)</em>. <a href="https://multithreaded.stitchfix.com/blog/2015/07/30/gam/">https://multithreaded.stitchfix.com/blog/2015/07/30/gam/</a>.
</div>
<div id="ref-pedersenHierarchical2019" class="csl-entry" role="doc-biblioentry">
Pedersen, Eric J., David L. Miller, Gavin L. Simpson, and Noam Ross. 2019. <span>“Hierarchical Generalized Additive Models in Ecology: An Introduction with Mgcv.”</span> <em>PeerJ</em> 7 (May): e6876. <a href="https://doi.org/10.7717/peerj.6876">https://doi.org/10.7717/peerj.6876</a>.
</div>
<div id="ref-perperogloureview2019a" class="csl-entry" role="doc-biblioentry">
Perperoglou, Aris, Willi Sauerbrei, Michal Abrahamowicz, and Matthias Schmid. 2019. <span>“A Review of Spline Function Procedures in <span>R</span>.”</span> <em>BMC Medical Research Methodology</em> 19 (1): 46. <a href="https://doi.org/10.1186/s12874-019-0666-3">https://doi.org/10.1186/s12874-019-0666-3</a>.
</div>
<div id="ref-pyaShape2015" class="csl-entry" role="doc-biblioentry">
Pya, Natalya, and Simon N. Wood. 2015. <span>“Shape Constrained Additive Models.”</span> <em>Statistics and Computing</em> 25 (3): 543–59. <a href="https://doi.org/10.1007/s11222-013-9448-7">https://doi.org/10.1007/s11222-013-9448-7</a>.
</div>
<div id="ref-ramsayEffect2003" class="csl-entry" role="doc-biblioentry">
Ramsay, Timothy O., Richard T. Burnett, and Daniel Krewski. 2003. <span>“The <span>Effect</span> of <span>Concurvity</span> in <span>Generalized</span> <span>Additive</span> <span>Models</span> <span>Linking</span> <span>Mortality</span> to <span>Ambient</span> <span>Particulate</span> <span>Matter</span>.”</span> <em>Epidemiology</em> 14 (1): 18. <a href="https://journals.lww.com/epidem/Fulltext/2003/01000/The_Effect_of_Concurvity_in_Generalized_Additive.9.aspx">https://journals.lww.com/epidem/Fulltext/2003/01000/The_Effect_of_Concurvity_in_Generalized_Additive.9.aspx</a>.
</div>
<div id="ref-woodStable2004" class="csl-entry" role="doc-biblioentry">
Wood, Simon N. 2004. <span>“Stable and <span>Efficient Multiple Smoothing Parameter Estimation</span> for <span>Generalized Additive Models</span>.”</span> <em>Journal of the American Statistical Association</em> 99 (467): 673–86. <a href="https://doi.org/10.1198/016214504000000980">https://doi.org/10.1198/016214504000000980</a>.
</div>
<div id="ref-woodGeneralized2017" class="csl-entry" role="doc-biblioentry">
Wood, Simon N. 2017. <em>Generalized <span>Additive Models</span>: <span>An Introduction</span> with <span>R</span></em>. <span>CRC Texts</span> in <span>Statistical Science</span>. <span>Chapman &amp; Hall</span>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>