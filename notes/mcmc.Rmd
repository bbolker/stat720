---
bibliography: "../stats720.bib"
---

```{r pkgs}
library(MCMCglmm)
library(brms)
library(rstanarm)
library(lme4)
options(brms.backend = "cmdstanr")
library(broom.mixed)
library(purrr)
library(dplyr)
library(tidybayes)
library(bayesplot)
library(bayestestR)
library(ggplot2); theme_set(theme_bw())
```

* a little more on priors:
    * parameter-expanded priors: $y_j | \mu, \xi_j \sim N(\mu + \alpha \sigma_j, \sigma^2_j)$, $\sigma_j \sim N(0, \sigma^\xi^2)$; $\alpha \sim N(\alpha_0, \sigma_\alpha)$, $\sigma_\alpha \sim \textrm{inverse-Gamma}(\nu)$
	
```{r eval = FALSE}
df(v/alpha.V, df1 = 1, df2 = nu, ncp = (alpha.mu^2)/alpha.V)
2 * dt(sqrt(v)/sqrt(alpha.V), df = nu, ncp = alpha.mu/sqrt(alpha.V))
```

... always set `alpha.mu=0`, can set `V = 1` (or `diag()` in more complex cases) wlog; `sqrt(alpha.V)` (scale) and `nu` are the only relevant parameters

* `rstanarm` default priors: https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html

```{r}
default_prior_test <- stan_lmer(Reaction ~ Days + (Days|Subject), data = sleepstudy, chains = 1)
prior_summary(default_prior_test)
priorpred <- stan_lmer(Reaction ~ Days + (Days|Subject),
                       prior_PD = TRUE, data = sleepstudy, chains = 1)
plot(priorpred, pars = c("(Intercept)", "Days"))
plot(priorpred, regex_pars = "Sigma")

postpred <- stan_lmer(Reaction ~ Days + (Days|Subject),
                      data = sleepstudy, chains = 4)

library(shinystan)
launch_shinystan(postpred)
```

```{r}
mcmc_trace(postpred, regex_pars= "Sigma")
mcmc_rank_overlay(postpred, regex_pars= "Sigma")
```

* MCMC diagnostics
   * trace plots, improved trace plots
   * R-hat @vehtariRankNormalization2021a
   * divergences (HMC only)

See http://bbolker.github.io/bbmisc/bayes/examples.html


```{r}
form1 <- Reaction ~ Days + (Days|Subject)
get_prior(form1, sleepstudy)
b_prior <- c(set_prior("normal(200, 50)", "Intercept"),
             set_prior("normal(0, 10)", "b")
             )
```

```{r}
b <- brm(form1, sleepstudy, 
         prior = b_prior,
         seed = 101,              ## reproducibility
         sample_prior = 'only',   ## for prior predictive sim
         chains = 1, iter = 500,  ## very short sample for convenience
         silent = 2, refresh = 0  ## be vewy vewy quiet ...
         )
p_df <- sleepstudy |> add_predicted_draws(b)
## 'spaghetti plot' of prior preds
gg0 <- ggplot(p_df,aes(Days, .prediction, group=interaction(Subject,.draw))) +
        geom_line(alpha = 0.1)
```

```{r}
b_reg <- brm(form1, sleepstudy, prior = b_prior5,
             seed = 101,
             control = list(adapt_delta = 0.95)
             )
```
